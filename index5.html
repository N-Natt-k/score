<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบตรวจสอบคะแนนสอบเข้า - โรงเรียนสตรีพัทลุง</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Sarabun', 'sans-serif'] },
                    colors: {
                        spt: { primary: '#E91E63', secondary: '#FCE4EC', dark: '#880E4F' }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f8fafc; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.5); }
        .editable-cell:focus { background-color: #fff; outline: 2px solid #E91E63; z-index: 10; }
        /* Smooth Fade */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="text-slate-700 min-h-screen flex flex-col font-sans text-sm md:text-base">

    <!-- Navbar -->
    <nav class="sticky top-0 z-40 glass-panel shadow-sm">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-3 cursor-pointer" onclick="window.location.reload()">
                    <img src="https://spt-curriculum.vercel.app/spt.png" class="h-10 w-auto">
                    <div>
                        <div class="font-bold text-spt-primary leading-tight">Satri Phatthalung</div>
                        <div class="text-[10px] text-slate-500">Admission System</div>
                    </div>
                </div>
                <div class="flex gap-3 items-center">
                    <span id="user-display" class="hidden text-xs bg-pink-50 text-pink-700 px-3 py-1 rounded-full font-bold"></span>
                    <button id="btn-logout" class="hidden text-xs md:text-sm bg-slate-100 hover:bg-slate-200 px-4 py-2 rounded-full transition">
                        <i class="fas fa-sign-out-alt"></i> ออกจากระบบ
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <main class="flex-grow w-full max-w-7xl mx-auto px-4 py-6 relative">
        
        <!-- Loading Overlay -->
        <div id="loading" class="fixed inset-0 bg-white/80 z-50 flex flex-col items-center justify-center hidden">
            <div class="animate-spin rounded-full h-12 w-12 border-4 border-spt-primary border-t-transparent"></div>
            <p class="mt-3 text-spt-primary font-bold">กำลังโหลด...</p>
        </div>

        <!-- PAGE: Login -->
        <section id="page-login" class="view-section fade-in flex justify-center items-center min-h-[60vh]">
            <div class="bg-white p-8 rounded-3xl shadow-lg w-full max-w-md border border-slate-100">
                <div class="flex justify-center mb-6">
                    <div class="bg-slate-100 p-1 rounded-xl flex w-full">
                        <button onclick="switchTab('student')" id="tab-student" class="flex-1 py-2 rounded-lg text-sm font-bold bg-white shadow-sm text-spt-primary transition-all">นักเรียน</button>
                        <button onclick="switchTab('admin')" id="tab-admin" class="flex-1 py-2 rounded-lg text-sm font-bold text-slate-400 hover:text-slate-600 transition-all">ผู้ดูแล</button>
                    </div>
                </div>

                <!-- Student Login -->
                <form id="form-student" class="space-y-4">
                    <div class="text-center">
                        <h2 class="text-xl font-bold text-slate-800">ตรวจสอบผลคะแนน</h2>
                        <p class="text-xs text-slate-500">กรอกเลขประจำตัวประชาชน 13 หลัก</p>
                    </div>
                    <input type="text" id="login-id" maxlength="13" placeholder="เลขบัตรประชาชน" class="w-full p-3 bg-slate-50 border rounded-xl focus:ring-2 focus:ring-spt-primary/50 outline-none text-center tracking-widest text-lg" required>
                    <button type="submit" class="w-full bg-spt-primary hover:bg-spt-dark text-white py-3 rounded-xl font-bold shadow-lg shadow-spt-primary/30 transition-all">ตรวจสอบ</button>
                </form>

                <!-- Admin Login -->
                <form id="form-admin" class="space-y-4 hidden">
                    <div class="text-center">
                        <h2 class="text-xl font-bold text-slate-800">สำหรับผู้ดูแลระบบ</h2>
                    </div>
                    <input type="email" id="login-email" placeholder="Email" class="w-full p-3 bg-slate-50 border rounded-xl outline-none" required>
                    <input type="password" id="login-pass" placeholder="Password" class="w-full p-3 bg-slate-50 border rounded-xl outline-none" required>
                    <button type="submit" class="w-full bg-slate-800 hover:bg-slate-900 text-white py-3 rounded-xl font-bold transition-all">เข้าสู่ระบบ</button>
                </form>
            </div>
        </section>

        <!-- PAGE: Student Dashboard -->
        <section id="page-student" class="view-section hidden fade-in">
            <h1 class="text-2xl font-bold mb-6 text-slate-800">ผลการสอบของฉัน</h1>
            <div id="student-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Cards Injected Here -->
            </div>
        </section>

        <!-- PAGE: Admin Dashboard -->
        <section id="page-admin" class="view-section hidden fade-in">
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-2xl font-bold text-slate-800">จัดการโครงการสอบ</h1>
                <button onclick="openModal('modal-create-project')" class="bg-spt-primary text-white px-5 py-2.5 rounded-xl font-bold shadow-lg shadow-spt-primary/30 hover:scale-105 transition-transform">
                    <i class="fas fa-plus mr-2"></i> สร้างโครงการ
                </button>
            </div>
            <div id="admin-project-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Project Cards Injected Here -->
            </div>
        </section>

        <!-- PAGE: Project Detail -->
        <section id="page-detail" class="view-section hidden fade-in flex flex-col h-[85vh]">
            <!-- Header & Toolbar -->
            <div class="mb-4 flex flex-col md:flex-row gap-4 justify-between md:items-center">
                <div class="flex items-center gap-3">
                    <button onclick="window.router.navigate('admin')" class="w-10 h-10 flex items-center justify-center bg-white border rounded-xl hover:bg-slate-50 text-slate-500 shadow-sm transition">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div>
                        <h1 id="detail-title" class="text-xl font-bold text-slate-800">ชื่อโครงการ</h1>
                        <p class="text-xs text-slate-500" id="detail-subtitle">0 รายวิชา</p>
                    </div>
                </div>
                
                <div class="flex flex-wrap gap-2">
                     <button onclick="toggleVisibility()" id="btn-visibility" class="px-4 py-2 bg-white border rounded-xl text-xs font-bold shadow-sm hover:bg-slate-50">
                        <i class="fas fa-eye"></i> แสดงผล
                    </button>
                    <button onclick="openModal('modal-add-student')" class="px-4 py-2 bg-spt-primary text-white rounded-xl text-xs font-bold shadow-sm hover:bg-spt-dark">
                        <i class="fas fa-user-plus"></i> เพิ่ม นร.
                    </button>
                    <button onclick="document.getElementById('csv-student').click()" class="px-4 py-2 bg-green-50 text-green-700 border border-green-100 rounded-xl text-xs font-bold hover:bg-green-100">
                        <i class="fas fa-file-csv"></i> CSV รายชื่อ
                    </button>
                    <button onclick="document.getElementById('csv-score').click()" class="px-4 py-2 bg-blue-50 text-blue-700 border border-blue-100 rounded-xl text-xs font-bold hover:bg-blue-100">
                        <i class="fas fa-table"></i> CSV คะแนน
                    </button>
                    <button onclick="exportCSV()" class="px-4 py-2 bg-slate-700 text-white rounded-xl text-xs font-bold hover:bg-slate-800">
                        <i class="fas fa-download"></i> Export
                    </button>
                     <button onclick="deleteCurrentProject()" class="px-3 py-2 bg-red-50 text-red-500 border border-red-100 rounded-xl hover:bg-red-100">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                <!-- Hidden Inputs -->
                <input type="file" id="csv-student" accept=".csv" class="hidden" onchange="importStudents(this)">
                <input type="file" id="csv-score" accept=".csv" class="hidden" onchange="importScores(this)">
            </div>

            <!-- Table Controls -->
            <div class="flex justify-between items-center bg-white p-3 rounded-t-2xl border-b border-slate-100 shadow-sm z-10">
                <div class="relative">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                    <input type="text" id="search-box" placeholder="ค้นหาชื่อ, เลขที่สอบ..." class="pl-9 pr-4 py-2 bg-slate-50 rounded-lg text-sm focus:outline-none w-64">
                </div>
                <div class="flex items-center gap-2">
                    <label class="flex items-center gap-2 cursor-pointer bg-yellow-50 px-3 py-2 rounded-lg border border-yellow-100 hover:bg-yellow-100 transition">
                        <input type="checkbox" id="edit-mode-toggle" class="accent-spt-primary w-4 h-4">
                        <span class="text-xs font-bold text-yellow-700"><i class="fas fa-edit mr-1"></i> โหมดแก้ไขคะแนน</span>
                    </label>
                </div>
            </div>

            <!-- Data Table (Scrollable) -->
            <div class="bg-white flex-grow overflow-auto shadow-sm border border-slate-100 rounded-b-2xl relative">
                <table class="w-full text-left border-collapse whitespace-nowrap">
                    <thead class="bg-slate-50 sticky top-0 z-20 shadow-sm text-xs font-semibold text-slate-500 uppercase">
                        <tr>
                            <th class="px-4 py-3 w-16 text-center">ที่</th>
                            <th class="px-4 py-3">เลขที่สอบ</th>
                            <th class="px-4 py-3">ชื่อ-สกุล</th>
                            <th id="dynamic-headers-start" class="hidden"></th>
                            <th class="px-4 py-3 text-center bg-slate-100 text-spt-primary font-bold">รวม</th>
                            <th class="px-4 py-3 text-center">ลบ</th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="divide-y divide-slate-100 text-sm">
                        <!-- Rows -->
                    </tbody>
                </table>
            </div>
            
             <!-- Footer Stats -->
             <div id="stats-bar" class="mt-4 p-4 bg-white rounded-2xl shadow-sm flex gap-4 overflow-x-auto text-xs font-medium text-slate-500"></div>
        </section>

    </main>

    <!-- MODAL: Create Project -->
    <div id="modal-create-project" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-lg p-6 shadow-2xl animate-fade-in max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4">สร้างโครงการใหม่</h3>
            <form id="form-create-project" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold mb-1">ชื่อโครงการ</label>
                    <input type="text" name="name" class="w-full p-2 border rounded-xl" required>
                </div>
                <div>
                    <div class="flex justify-between mb-2">
                        <label class="block text-xs font-bold">รายวิชา</label>
                        <button type="button" onclick="addSubjectRow()" class="text-xs text-spt-primary font-bold">+ เพิ่มวิชา</button>
                    </div>
                    <div id="subject-rows" class="space-y-2">
                        <!-- JS Add Rows Here -->
                    </div>
                </div>
                <div class="flex gap-2 pt-4">
                    <button type="button" onclick="closeModal('modal-create-project')" class="flex-1 py-2 border rounded-xl font-bold text-slate-500">ยกเลิก</button>
                    <button type="submit" class="flex-1 py-2 bg-spt-primary text-white rounded-xl font-bold">บันทึก</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL: Add Student (Fixed) -->
    <div id="modal-add-student" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-md p-6 shadow-2xl animate-fade-in">
            <h3 class="text-xl font-bold mb-4">เพิ่มนักเรียน</h3>
            <form id="form-add-student" class="space-y-3">
                <div class="grid grid-cols-2 gap-3">
                     <div>
                        <label class="text-xs font-bold">เลขที่ผู้สมัคร/สอบ</label>
                        <input type="text" name="examId" class="w-full p-2 border rounded-xl" required>
                    </div>
                    <div>
                         <label class="text-xs font-bold">เลข ปชช. (13 หลัก)</label>
                        <input type="text" name="citizenId" maxlength="13" class="w-full p-2 border rounded-xl" required>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-2">
                    <div class="col-span-1">
                        <label class="text-xs font-bold">คำนำหน้า</label>
                        <select name="prefix" class="w-full p-2 border rounded-xl">
                            <option>ด.ญ.</option><option>ด.ช.</option><option>น.ส.</option><option>นาย</option>
                        </select>
                    </div>
                    <div class="col-span-2">
                        <label class="text-xs font-bold">ชื่อ</label>
                        <input type="text" name="name" class="w-full p-2 border rounded-xl" required>
                    </div>
                </div>
                <div>
                    <label class="text-xs font-bold">นามสกุล</label>
                    <input type="text" name="surname" class="w-full p-2 border rounded-xl" required>
                </div>
                <div>
                    <label class="text-xs font-bold">โรงเรียนเดิม</label>
                    <input type="text" name="oldSchool" class="w-full p-2 border rounded-xl">
                </div>
                <div class="flex gap-2 pt-4">
                    <button type="button" onclick="closeModal('modal-add-student')" class="flex-1 py-2 border rounded-xl font-bold text-slate-500">ยกเลิก</button>
                    <button type="submit" class="flex-1 py-2 bg-spt-primary text-white rounded-xl font-bold">เพิ่มข้อมูล</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signInAnonymously, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, getDocs, setDoc, addDoc, updateDoc, deleteDoc, query, where, writeBatch, orderBy } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyBWJmndz8RpKxW2DwPbl6P--G6QhDTqlqA",
            authDomain: "spt-score.firebaseapp.com",
            projectId: "spt-score",
            storageBucket: "spt-score.firebasestorage.app",
            messagingSenderId: "159154369203",
            appId: "1:159154369203:web:7cfb79bc3b65bb4d75b6c6",
            measurementId: "G-ZH8KVVWWK0"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // GLOBAL STATE
        const state = {
            user: null,
            isAdmin: false,
            currentProject: null,
            studentsCache: [],
            editMode: false
        };

        // --- 1. ROUTER & GLOBAL FUNCTIONS ---
        // Expose functions to window so HTML onlick="" works
        window.router = {
            navigate: (page) => {
                document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                document.getElementById(`page-${page}`).classList.remove('hidden');
                
                if(page === 'login') {
                    document.getElementById('user-display').classList.add('hidden');
                    document.getElementById('btn-logout').classList.add('hidden');
                } else {
                    document.getElementById('btn-logout').classList.remove('hidden');
                }
            }
        };

        window.switchTab = (tab) => {
            const btnStudent = document.getElementById('tab-student');
            const btnAdmin = document.getElementById('tab-admin');
            const formStudent = document.getElementById('form-student');
            const formAdmin = document.getElementById('form-admin');

            if(tab === 'student') {
                btnStudent.className = "flex-1 py-2 rounded-lg text-sm font-bold bg-white shadow-sm text-spt-primary transition-all";
                btnAdmin.className = "flex-1 py-2 rounded-lg text-sm font-bold text-slate-400 hover:text-slate-600 transition-all";
                formStudent.classList.remove('hidden');
                formAdmin.classList.add('hidden');
            } else {
                btnAdmin.className = "flex-1 py-2 rounded-lg text-sm font-bold bg-white shadow-sm text-spt-primary transition-all";
                btnStudent.className = "flex-1 py-2 rounded-lg text-sm font-bold text-slate-400 hover:text-slate-600 transition-all";
                formAdmin.classList.remove('hidden');
                formStudent.classList.add('hidden');
            }
        };

        window.openModal = (id) => document.getElementById(id).classList.remove('hidden');
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');

        window.addSubjectRow = () => {
            const container = document.getElementById('subject-rows');
            const div = document.createElement('div');
            div.className = "flex gap-2 items-center";
            div.innerHTML = `
                <input type="text" placeholder="ชื่อวิชา" class="flex-grow p-2 border rounded-lg text-sm" required>
                <input type="number" placeholder="เต็ม" class="w-16 p-2 border rounded-lg text-sm" required>
                <input type="number" placeholder="นน." value="1" class="w-14 p-2 border rounded-lg text-sm" required>
                <button type="button" onclick="this.parentElement.remove()" class="text-red-400"><i class="fas fa-times"></i></button>
            `;
            container.appendChild(div);
        };

        // --- 2. AUTHENTICATION ---
        onAuthStateChanged(auth, (user) => {
            const loader = document.getElementById('loading');
            loader.classList.add('hidden');
            
            if (user) {
                state.user = user;
                if (!user.isAnonymous) {
                    // Admin
                    state.isAdmin = true;
                    document.getElementById('user-display').innerText = "Admin";
                    document.getElementById('user-display').classList.remove('hidden');
                    loadAdminProjects();
                    window.router.navigate('admin');
                }
            } else {
                state.user = null;
                state.isAdmin = false;
                window.router.navigate('login');
            }
        });

        document.getElementById('form-student').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('login-id').value;
            if(id.length !== 13) return Swal.fire('Error', 'เลขบัตรต้องมี 13 หลัก', 'error');

            document.getElementById('loading').classList.remove('hidden');
            try {
                if(!auth.currentUser) await signInAnonymously(auth);
                
                // Find student records
                const q = query(collection(db, 'students'), where('citizenId', '==', id));
                const snaps = await getDocs(q);
                
                if(snaps.empty) throw new Error('ไม่พบข้อมูลนักเรียน');

                const records = [];
                snaps.forEach(doc => records.push({id: doc.id, ...doc.data()}));
                
                await renderStudentDashboard(records);
                
                const s = records[0];
                document.getElementById('user-display').innerText = `${s.prefix}${s.name}`;
                document.getElementById('user-display').classList.remove('hidden');
                window.router.navigate('student');
            } catch (err) {
                Swal.fire('ไม่พบข้อมูล', 'กรุณาตรวจสอบเลขบัตรประชาชน', 'warning');
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        });

        document.getElementById('form-admin').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch(err) {
                Swal.fire('เข้าสู่ระบบไม่สำเร็จ', err.message, 'error');
            }
        });

        document.getElementById('btn-logout').addEventListener('click', () => {
             Swal.fire({
                title: 'ออกจากระบบ?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'ใช่',
                cancelButtonText: 'ยกเลิก'
            }).then((result) => {
                if(result.isConfirmed) signOut(auth);
            });
        });

        // --- 3. STUDENT DASHBOARD LOGIC ---
        async function renderStudentDashboard(records) {
            const container = document.getElementById('student-cards');
            container.innerHTML = '';

            for(const rec of records) {
                // Get project details
                const projDoc = await getDoc(doc(db, 'projects', rec.projectId));
                if(!projDoc.exists()) continue;
                const proj = projDoc.data();
                if(!proj.isVisible) continue;

                // Calculate Rank
                const allQ = query(collection(db, 'students'), where('projectId', '==', rec.projectId));
                const allSnaps = await getDocs(allQ);
                const scoresList = [];
                allSnaps.forEach(d => {
                    let sum = 0;
                    proj.subjects.forEach(s => sum += parseFloat(d.data().scores[s.name] || 0));
                    scoresList.push(sum);
                });
                
                scoresList.sort((a,b) => b-a);
                let myTotal = 0;
                proj.subjects.forEach(s => myTotal += parseFloat(rec.scores[s.name] || 0));
                
                const myRank = scoresList.indexOf(myTotal) + 1;
                const totalStudents = scoresList.length;
                const percentile = ((totalStudents - myRank) / totalStudents) * 100;

                // Build Card HTML
                let subjectsHTML = '';
                proj.subjects.forEach(s => {
                    const sc = parseFloat(rec.scores[s.name]||0);
                    subjectsHTML += `
                        <div class="flex justify-between py-2 border-b border-slate-100 last:border-0 text-sm">
                            <span class="text-slate-600">${s.name}</span>
                            <div class="flex gap-4">
                                <span class="font-bold text-slate-800">${sc}</span>
                                <span class="text-slate-400 text-xs mt-1">/${s.max}</span>
                            </div>
                        </div>
                    `;
                });

                const div = document.createElement('div');
                div.className = "bg-white rounded-3xl shadow-soft overflow-hidden border border-slate-100 hover:shadow-lg transition-shadow";
                div.innerHTML = `
                    <div class="bg-gradient-to-r from-spt-primary to-pink-600 p-6 text-white relative">
                        <div class="absolute top-0 right-0 p-4 opacity-20 text-6xl"><i class="fas fa-graduation-cap"></i></div>
                        <h3 class="font-bold text-lg">${proj.name}</h3>
                        <p class="text-sm opacity-90">เลขที่สอบ: ${rec.examId}</p>
                    </div>
                    <div class="p-6">
                         <div class="flex justify-between items-center mb-4 bg-slate-50 p-4 rounded-2xl">
                            <div class="text-center">
                                <div class="text-xs text-slate-500 uppercase">คะแนนรวม</div>
                                <div class="text-2xl font-bold text-spt-primary">${myTotal.toFixed(2)}</div>
                            </div>
                            <div class="h-8 w-px bg-slate-200"></div>
                            <div class="text-center">
                                <div class="text-xs text-slate-500 uppercase">ลำดับที่</div>
                                <div class="text-2xl font-bold text-slate-700">#${myRank}</div>
                                <div class="text-[10px] text-slate-400">/${totalStudents}</div>
                            </div>
                        </div>
                        <div class="space-y-1 mb-4">${subjectsHTML}</div>
                        <div class="flex justify-between text-xs text-slate-400 pt-2 border-t border-slate-50">
                            <span>Percentile: ${percentile.toFixed(2)}</span>
                            <span>Max: ${scoresList[0]}</span>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            }
        }

        // --- 4. ADMIN LOGIC ---
        async function loadAdminProjects() {
            const container = document.getElementById('admin-project-list');
            container.innerHTML = '<div class="col-span-3 text-center py-10"><div class="animate-spin inline-block w-8 h-8 border-4 border-current border-t-transparent text-spt-primary rounded-full"></div></div>';
            
            const snaps = await getDocs(collection(db, 'projects'));
            container.innerHTML = '';
            
            snaps.forEach(docSnap => {
                const p = docSnap.data();
                const div = document.createElement('div');
                div.className = "bg-white p-6 rounded-2xl shadow-sm border hover:border-spt-primary/50 cursor-pointer group transition-all";
                div.onclick = () => openProjectDetail(docSnap.id, p);
                div.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div class="w-12 h-12 bg-pink-50 rounded-xl flex items-center justify-center text-spt-primary text-xl group-hover:scale-110 transition-transform">
                            <i class="fas fa-folder"></i>
                        </div>
                        <span class="text-[10px] px-2 py-1 rounded-full ${p.isVisible ? 'bg-green-100 text-green-700' : 'bg-slate-100 text-slate-500'}">
                            ${p.isVisible ? 'เผยแพร่' : 'ซ่อน'}
                        </span>
                    </div>
                    <h3 class="font-bold text-lg text-slate-800 mb-1">${p.name}</h3>
                    <p class="text-xs text-slate-400">${p.subjects.length} รายวิชา</p>
                `;
                container.appendChild(div);
            });
        }

        document.getElementById('form-create-project').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const subjects = [];
            const rows = document.querySelectorAll('#subject-rows > div');
            rows.forEach(r => {
                const inputs = r.querySelectorAll('input');
                subjects.push({ name: inputs[0].value, max: parseFloat(inputs[1].value), weight: parseFloat(inputs[2].value) });
            });
            
            await addDoc(collection(db, 'projects'), {
                name: formData.get('name'),
                subjects: subjects,
                isVisible: false,
                createdAt: new Date()
            });
            
            closeModal('modal-create-project');
            loadAdminProjects();
        });

        // --- 5. PROJECT DETAIL & TABLE LOGIC ---
        window.openProjectDetail = async (id, data) => {
            state.currentProject = { id, ...data };
            state.editMode = false;
            document.getElementById('edit-mode-toggle').checked = false;
            
            document.getElementById('detail-title').innerText = data.name;
            document.getElementById('detail-subtitle').innerText = `${data.subjects.length} รายวิชา`;
            document.getElementById('btn-visibility').innerHTML = `<i class="fas fa-eye${data.isVisible ? '-slash' : ''}"></i> ${data.isVisible ? 'ซ่อนผล' : 'แสดงผล'}`;

            // Build Header
            const headerRow = document.querySelector('thead tr');
            // Reset to static headers
            headerRow.innerHTML = `
                <th class="px-4 py-3 w-16 text-center text-slate-400">#</th>
                <th class="px-4 py-3 w-32">เลขที่สอบ</th>
                <th class="px-4 py-3 w-48">ชื่อ-สกุล</th>
            `;
            data.subjects.forEach(s => {
                headerRow.innerHTML += `<th class="px-4 py-3 text-center bg-slate-50/50 min-w-[100px]"><div class="flex flex-col"><span class="text-slate-700">${s.name}</span><span class="text-[10px] text-slate-400">เต็ม ${s.max}</span></div></th>`;
            });
            headerRow.innerHTML += `<th class="px-4 py-3 text-center bg-spt-secondary/30 text-spt-primary font-bold">รวม</th><th class="px-4 py-3 text-center w-16">ลบ</th>`;

            await loadStudents(id);
            window.router.navigate('detail');
        };

        async function loadStudents(projId) {
            document.getElementById('loading').classList.remove('hidden');
            const q = query(collection(db, 'students'), where('projectId', '==', projId));
            const snaps = await getDocs(q);
            state.studentsCache = [];
            snaps.forEach(d => state.studentsCache.push({ id: d.id, ...d.data() }));
            
            calculateAndRender();
            document.getElementById('loading').classList.add('hidden');
        }

        function calculateAndRender() {
            const proj = state.currentProject;
            const filter = document.getElementById('search-box').value.toLowerCase();
            
            // Calc Totals & Rank
            state.studentsCache.forEach(s => {
                let total = 0;
                proj.subjects.forEach(sub => total += parseFloat(s.scores[sub.name] || 0));
                s.total = parseFloat(total.toFixed(2));
            });
            state.studentsCache.sort((a,b) => b.total - a.total); // Sort by total score

            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            
            let statsTotal = 0;

            state.studentsCache.forEach((s, idx) => {
                const fullName = `${s.prefix}${s.name} ${s.surname}`;
                if(filter && !fullName.toLowerCase().includes(filter) && !s.examId.includes(filter)) return;
                
                statsTotal++;
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 border-b border-slate-50 transition-colors";
                
                let cells = `
                    <td class="px-4 py-3 text-center text-slate-400 font-mono">${idx + 1}</td>
                    <td class="px-4 py-3 font-mono text-slate-600 font-medium">${s.examId}</td>
                    <td class="px-4 py-3 font-medium text-slate-800">${fullName}</td>
                `;

                proj.subjects.forEach(sub => {
                    // Check if edit mode is active
                    const val = s.scores[sub.name] || 0;
                    const display = state.editMode ? 
                        `<input type="number" value="${val}" class="w-full text-center p-1 border border-spt-primary/30 rounded focus:ring-2 focus:ring-spt-primary outline-none bg-white" 
                          onblur="updateScoreInline('${s.id}', '${sub.name}', this.value)" 
                          onkeydown="handleEnter(event, this)">` 
                        : val;
                        
                    cells += `<td class="px-4 py-3 text-center border-l border-dashed border-slate-100">${display}</td>`;
                });

                cells += `
                    <td class="px-4 py-3 text-center font-bold text-spt-primary bg-spt-secondary/5">${s.total}</td>
                    <td class="px-4 py-3 text-center"><button onclick="deleteStudent('${s.id}')" class="text-slate-300 hover:text-red-500"><i class="fas fa-trash"></i></button></td>
                `;
                
                tr.innerHTML = cells;
                tbody.appendChild(tr);
            });

            // Update Stats Footer
            document.getElementById('stats-bar').innerHTML = `
                <div>จำนวน: <span class="font-bold text-slate-800">${statsTotal}</span> คน</div>
                <div class="h-4 w-px bg-slate-300"></div>
                <div>สูงสุด: <span class="font-bold text-green-600">${state.studentsCache.length > 0 ? state.studentsCache[0].total : 0}</span></div>
                <div class="h-4 w-px bg-slate-300"></div>
                <div>ต่ำสุด: <span class="font-bold text-red-600">${state.studentsCache.length > 0 ? state.studentsCache[state.studentsCache.length-1].total : 0}</span></div>
            `;
        }

        // --- 6. ACTIONS & HANDLERS ---
        
        // Add Student
        document.getElementById('form-add-student').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fd = new FormData(e.target);
            const data = Object.fromEntries(fd.entries());
            data.projectId = state.currentProject.id;
            data.scores = {};
            
            try {
                await addDoc(collection(db, 'students'), data);
                closeModal('modal-add-student');
                e.target.reset();
                Swal.fire({ icon: 'success', title: 'เพิ่มเรียบร้อย', toast: true, position: 'top-end', showConfirmButton: false, timer: 1500 });
                loadStudents(state.currentProject.id);
            } catch(err) { Swal.fire('Error', err.message, 'error'); }
        });

        // Toggle Edit Mode
        document.getElementById('edit-mode-toggle').addEventListener('change', (e) => {
            state.editMode = e.target.checked;
            calculateAndRender(); // Re-render table with/without inputs
        });

        // Search
        document.getElementById('search-box').addEventListener('keyup', calculateAndRender);

        // Update Score (Inline)
        window.updateScoreInline = async (id, subject, val) => {
            const num = parseFloat(val);
            if(isNaN(num)) return;
            
            // Local Update
            const stu = state.studentsCache.find(s => s.id === id);
            if(stu) stu.scores[subject] = num;
            
            // Debounce or immediate update? For safety, immediate.
            try {
                await updateDoc(doc(db, 'students', id), { [`scores.${subject}`]: num });
                // We re-calculate locally to update Total column immediately without DB fetch
                calculateAndRender();
            } catch(e) { console.error(e); }
        };
        
        window.handleEnter = (e, input) => {
            if(e.key === 'Enter') {
                input.blur(); // Trigger onblur
                // Logic to move to next cell could be added here
            }
        };

        window.deleteStudent = async (id) => {
            if(!confirm('ลบรายชื่อนี้?')) return;
            await deleteDoc(doc(db, 'students', id));
            loadStudents(state.currentProject.id);
        };

        window.deleteCurrentProject = async () => {
            if(!confirm('ยืนยันลบโครงการนี้และข้อมูลทั้งหมด?')) return;
            document.getElementById('loading').classList.remove('hidden');
            await deleteDoc(doc(db, 'projects', state.currentProject.id));
            // In real app, batch delete students. Here simplified.
            const batch = writeBatch(db);
            state.studentsCache.forEach(s => batch.delete(doc(db, 'students', s.id)));
            await batch.commit();
            window.router.navigate('admin');
        };

        window.toggleVisibility = async () => {
            const p = state.currentProject;
            p.isVisible = !p.isVisible;
            await updateDoc(doc(db, 'projects', p.id), { isVisible: p.isVisible });
            document.getElementById('btn-visibility').innerHTML = `<i class="fas fa-eye${p.isVisible ? '-slash' : ''}"></i> ${p.isVisible ? 'ซ่อนผล' : 'แสดงผล'}`;
            Swal.fire({ icon: 'success', title: 'อัปเดตสถานะแล้ว', toast: true, position: 'top-end', timer: 1000, showConfirmButton: false });
        };

        // --- CSV Import/Export ---
        window.importStudents = (input) => {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const rows = e.target.result.split('\n').slice(1);
                const batch = writeBatch(db);
                rows.forEach(r => {
                    const c = r.split(',').map(s=>s.trim());
                    if(c.length < 5) return;
                    // id, examId, prefix, name, surname
                    const ref = doc(collection(db, 'students'));
                    batch.set(ref, {
                        projectId: state.currentProject.id,
                        citizenId: c[0], examId: c[1], prefix: c[2], name: c[3], surname: c[4], oldSchool: c[5]||'', scores: {}
                    });
                });
                await batch.commit();
                loadStudents(state.currentProject.id);
                Swal.fire('Success', 'นำเข้าข้อมูลเรียบร้อย', 'success');
            };
            reader.readAsText(file);
        };

        window.importScores = (input) => {
            // Logic similar to previous version but matches examId
             const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const lines = e.target.result.split('\n');
                const headers = lines[0].split(',').map(h=>h.trim());
                const batch = writeBatch(db);
                
                // Map examId -> docId
                const map = {};
                state.studentsCache.forEach(s => map[s.examId] = s.id);

                lines.slice(1).forEach(line => {
                    const cols = line.split(',').map(c=>c.trim());
                    const examId = cols[0];
                    if(!map[examId]) return;
                    
                    const updateData = {};
                    for(let i=1; i<cols.length; i++) {
                        if(headers[i] && cols[i]) updateData[`scores.${headers[i]}`] = parseFloat(cols[i]);
                    }
                    batch.update(doc(db, 'students', map[examId]), updateData);
                });
                await batch.commit();
                loadStudents(state.currentProject.id);
                Swal.fire('Success', 'อัปเดตคะแนนเรียบร้อย', 'success');
            };
            reader.readAsText(file);
        };

        window.exportCSV = () => {
             const proj = state.currentProject;
             const data = state.studentsCache.map(s => {
                 const row = { 'Rank': s.rank || '-', 'ExamID': s.examId, 'Name': `${s.prefix}${s.name} ${s.surname}` };
                 proj.subjects.forEach(sub => row[sub.name] = s.scores[sub.name]||0);
                 row['Total'] = s.total;
                 return row;
             });
             const ws = XLSX.utils.json_to_sheet(data);
             const wb = XLSX.utils.book_new();
             XLSX.utils.book_append_sheet(wb, ws, "Scores");
             XLSX.writeFile(wb, `${proj.name}_Export.csv`);
        };

        // Initialize empty Add Student Modal to be safe
        addSubjectRow(); // Add one default subject row in Create Modal
    </script>
</body>
</html>


